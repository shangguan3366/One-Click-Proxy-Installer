#!/usr/bin/env bash
# ====================================================
# 一键梭哈脚本 · 2026 Final v4.1 · 管理加强版
# 支持快捷指令：suoha quick / status / show / restart / cleanup ...
# ====================================================

set -euo pipefail
IFS=$'\n\t'

# ---------------- 基本路径与版本 ----------------
readonly VERSION="4.1"
readonly BASE_DIR="${HOME}/.suoha"
readonly BIN_DIR="${BASE_DIR}/bin"
readonly CONFIG_DIR="${BASE_DIR}/config"
readonly LOG_DIR="${BASE_DIR}/logs"
readonly NODES_DIR="${BASE_DIR}/nodes"

readonly XRAY_BIN="${BIN_DIR}/xray"
readonly ARGO_BIN="${BIN_DIR}/cloudflared"
readonly CONFIG_FILE="${BASE_DIR}/config.json"
readonly TUNNEL_CONFIG="${BASE_DIR}/tunnel.yaml"
readonly XRAY_LOG="${LOG_DIR}/xray.log"
readonly ARGO_LOG="${LOG_DIR}/argo.log"

mkdir -p "$BASE_DIR" "$BIN_DIR" "$CONFIG_DIR" "$LOG_DIR" "$NODES_DIR"

# ---------------- 颜色函数 ----------------
green()  { echo -e "\033[32m${1}\033[0m"; }
yellow() { echo -e "\033[33m${1}\033[0m"; }
red()    { echo -e "\033[31m${1}\033[0m"; }

# ---------------- 简单多语言（可后续扩展） ----------------
t() {
    local key="$1"
    case "$key" in
        welcome)          echo "===== 一键梭哈 v${VERSION} =====" ;;
        quick)            echo "启动临时隧道" ;;
        fixed)            echo "启动固定域名隧道（需要root）" ;;
        status)           echo "查看运行状态 + 节点" ;;
        show)             echo "只显示最近节点链接" ;;
        restart)          echo "重启服务（仅fixed有效）" ;;
        cleanup)          echo "停止并清理进程/服务" ;;
        logs)             echo "查看日志（xray 或 argo）" ;;
        update)           echo "检查/拉取更新（占位）" ;;
        need_root)        echo "此操作需要 root 权限" ;;
        argo_failed)      echo "获取 Argo 域名失败，请查看日志" ;;
        links_saved)      echo "节点已保存至" ;;
        running_ok)       echo "进程运行正常" ;;
        no_nodes)         echo "还没有生成过节点链接" ;;
        *)                echo "$key" ;;
    esac
}

# ---------------- 配置（可手动编辑） ----------------
PREFER_ADDR="cloudflare.518920.xyz"           # ← 这里可以改成你最新的优选
WS_PATH_PREFIX="s"
PORT_MIN=20000
PORT_MAX=49999
XRAY_LOGLEVEL="warning"

# ---------------- 工具函数 ----------------
random_port() {
    echo $((RANDOM % (PORT_MAX - PORT_MIN + 1) + PORT_MIN))
}

random_path() {
    tr -dc 'a-z0-9' </dev/urandom | head -c 10
}

wait_argo_domain() {
    local timeout=90 sec=0
    while (( sec < timeout )); do
        if grep -qE 'https://[-a-z0-9]+\.trycloudflare\.com' "$ARGO_LOG" 2>/dev/null; then
            sed -nE 's/.*(https:\/\/[-a-z0-9]+\.trycloudflare\.com).*/\1/p' "$ARGO_LOG" | tail -1 | sed 's|https://||'
            return 0
        fi
        sleep 2
        ((sec+=2))
    done
    red "$(t argo_failed)"
    return 1
}

check_processes() {
    sleep 4
    local ok=0
    pgrep -f xray >/dev/null && ((ok++))
    pgrep -f cloudflared >/dev/null && ((ok++))
    [[ $ok -eq 2 ]] && green "$(t running_ok)" && return 0
    red "进程异常（xray / cloudflared）"
    return 1
}

save_node() {
    local mode="$1" domain="$2" uuid="$3" path="$4" ts
    ts=$(date '+%Y-%m-%d %H:%M:%S')
    local vmess_json
    vmess_json=$(cat <<EOF
{"v":"2","ps":"Suoha_${mode}_${ts:5:5}","add":"${PREFER_ADDR}","port":"443","id":"${uuid}","aid":"0","net":"ws","type":"none","host":"${domain}","path":"/${path}","tls":"tls","sni":"${domain}"}
EOF
)
    local vmess="vmess://$(echo -n "$vmess_json" | base64 -w 0)"

    cat > "${NODES_DIR}/last-${mode,,}.txt" <<EOF
模式     : ${mode}
生成时间 : ${ts}
优选地址 : ${PREFER_ADDR}
域名/SNI : ${domain}
UUID     : ${uuid}
WS路径   : /${path}
端口     : 443 (tls+ws)

完整链接：
${vmess}
EOF

    cp "${NODES_DIR}/last-${mode,,}.txt" "${NODES_DIR}/current.txt"
    echo "${vmess}" > "${NODES_DIR}/vmess.txt"
    green "$(t links_saved) ${NODES_DIR}/current.txt"
    yellow "${vmess}"
}

show_node() {
    local f="${NODES_DIR}/current.txt"
    [[ -f "$f" ]] || { yellow "$(t no_nodes)"; return 1; }
    cat "$f"
}

show_status() {
    echo "进程状态："
    ps aux | grep -E 'xray|cloudflared' | grep -v grep || echo "  (无运行进程)"

    echo -e "\nSystemd 服务（fixed模式）："
    systemctl --no-pager status suoha-xray suoha-argo 2>/dev/null || echo "  未找到服务"

    echo -e "\n最近节点："
    show_node
}

view_logs() {
    local type="${1:-xray}"
    case "$type" in
        xray) tail -n 60 "$XRAY_LOG" ;;
        argo) tail -n 60 "$ARGO_LOG" ;;
        *) red "用法：suoha logs [xray|argo]"; return 1 ;;
    esac
}

# ---------------- 核心功能 ----------------
quick_tunnel() {
    UUID=$(uuidgen 2>/dev/null || cat /proc/sys/kernel/random/uuid)
    PORT=$(random_port)
    PATH_WS=$(random_path)

    cat >"$CONFIG_FILE" <<EOF
{
  "log": {"loglevel": "${XRAY_LOGLEVEL}"},
  "inbounds": [{
    "port": ${PORT},
    "listen": "127.0.0.1",
    "protocol": "vmess",
    "settings": {"clients": [{"id": "${UUID}"}]},
    "streamSettings": {"network": "ws", "wsSettings": {"path": "/${PATH_WS}"}}
  }],
  "outbounds": [{"protocol": "freedom"}]
}
EOF

    pkill -f "cloudflared tunnel" 2>/dev/null || true
    nohup "${XRAY_BIN}" run -c "$CONFIG_FILE" >"$XRAY_LOG" 2>&1 &
    nohup "${ARGO_BIN}" tunnel --url "http://127.0.0.1:${PORT}" >"$ARGO_LOG" 2>&1 &

    yellow "等待 Argo 域名（最多90秒）..."
    DOMAIN=$(wait_argo_domain) || exit 1

    save_node "Quick" "$DOMAIN" "$UUID" "$PATH_WS"
    check_processes
}

fixed_tunnel() {
    [[ $EUID -ne 0 ]] && { red "$(t need_root)"; exit 1; }

    UUID=$(uuidgen 2>/dev/null || cat /proc/sys/kernel/random/uuid)
    PORT=$(random_port)
    PATH_WS=$(random_path)

    read -r -p "请输入完整域名： " FULL_DOMAIN
    [[ -z "$FULL_DOMAIN" ]] && { red "域名不能为空"; exit 1; }

    T_NAME="suoha-fixed"

    "${ARGO_BIN}" tunnel create "$T_NAME" || true
    "${ARGO_BIN}" tunnel route dns "$T_NAME" "$FULL_DOMAIN"

    local creds
    creds=$(find ~/.cloudflared -name "*.json" -type f | grep -v config | head -n1)
    [[ -z "$creds" ]] && { red "找不到cloudflared凭证"; exit 1; }

    cat >"$TUNNEL_CONFIG" <<EOF
tunnel: $T_NAME
credentials-file: $creds
ingress:
  - hostname: $FULL_DOMAIN
    service: http://localhost:$PORT
  - service: http_status:404
EOF

    # systemd 服务文件
    cat >/etc/systemd/system/suoha-xray.service <<EOF2
[Unit]
Description=Suoha Xray
After=network.target

[Service]
ExecStart=${XRAY_BIN} run -c ${CONFIG_FILE}
Restart=always
User=$(whoami)

[Install]
WantedBy=multi-user.target
EOF2

    cat >/etc/systemd/system/suoha-argo.service <<EOF2
[Unit]
Description=Suoha Argo Tunnel
After=network.target

[Service]
ExecStart=${ARGO_BIN} tunnel --config ${TUNNEL_CONFIG} run ${T_NAME}
Restart=always
User=$(whoami)

[Install]
WantedBy=multi-user.target
EOF2

    systemctl daemon-reload
    systemctl enable --now suoha-xray suoha-argo

    # 等几秒再生成链接（让服务真正启动）
    sleep 6

    save_node "Fixed" "$FULL_DOMAIN" "$UUID" "$PATH_WS"
    check_processes
}

cleanup_all() {
    pkill -f xray 2>/dev/null || true
    pkill -f cloudflared 2>/dev/null || true
    systemctl disable --now suoha-xray suoha-argo 2>/dev/null || true
    green "已清理进程和服务"
}

# ---------------- 主入口 ----------------
if [[ $# -eq 0 ]]; then
    clear
    green "$(t welcome)"
    echo
    echo " 1) $(t quick)"
    echo " 2) $(t fixed)"
    echo " 3) $(t show)"
    echo " 4) $(t status)"
    echo " 5) $(t restart)"
    echo " 6) $(t cleanup)"
    echo " 7) 查看日志"
    echo " 0) 退出"
    echo
    read -r -n1 -p "请选择 [1-7,0] → " c
    echo
    case $c in
        1) quick_tunnel ;;
        2) fixed_tunnel ;;
        3) show_node ;;
        4) show_status ;;
        5) systemctl restart suoha-xray suoha-argo 2>/dev/null && green "重启完成" ;;
        6) cleanup_all ;;
        7) read -r -p "xray / argo ? " lt; view_logs "${lt:-xray}" ;;
        *) exit 0 ;;
    esac
    exit 0
fi

# 子命令模式
case "$1" in
    quick)      quick_tunnel ;;
    fixed)      fixed_tunnel ;;
    status)     show_status ;;
    show|link|nodes) show_node ;;
    restart)    systemctl restart suoha-xray suoha-argo 2>/dev/null && green "重启完成" ;;
    stop|cleanup) cleanup_all ;;
    logs)       shift; view_logs "${1:-xray}" ;;
    update)     echo "更新功能待实现，可手动 git pull 或重新下载" ;;
    -v|--version) echo "v${VERSION}" ;;
    *)          echo "支持的命令：quick fixed status show restart cleanup logs update"
                echo "无参数 → 进入菜单" ;;
esac