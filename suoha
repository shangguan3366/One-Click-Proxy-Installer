#!/bin/bash
# ====================================================
# 一键梭哈脚本 · 2026 Final v3.2 · STABLE
# 优化项：权限自动识别、Systemd 守护、目录权限加固
# ====================================================

set -euo pipefail

BASE_DIR="${HOME}/.suoha"
XRAY_BIN="$BASE_DIR/xray"
ARGO_BIN="$BASE_DIR/cloudflared"
CONFIG_FILE="$BASE_DIR/config.json"
TUNNEL_CONFIG="$BASE_DIR/config.yaml"
LOG_DIR="$BASE_DIR/logs"
XRAY_LOG="$LOG_DIR/xray.log"
ARGO_LOG="$LOG_DIR/argo.log"
LANG_FILE="$BASE_DIR/language"

# 初始化环境
mkdir -p "$BASE_DIR" "$LOG_DIR"
chmod 700 "$BASE_DIR"

# ---------------- 多语言 ----------------
declare -A zh=(
  [welcome]="===== 一键梭哈 (2026 v3.2) ====="
  [choose]="1) 临时隧道 (Quick)\n2) 固定隧道 (Domain + Auto-start)\n3) 清理所有进程\n0) 退出"
  [lang_prompt]="请选择语言 (1=中文 / 2=English): "
  [fixed_need]="需要 Cloudflare 托管域名，稍后请按提示完成浏览器授权"
  [fixed_domain]="请输入你在 CF 托管的完整域名 (如: node.example.com): "
  [fixed_success]="固定隧道已成功启动并配置自启动"
  [links_saved]="节点已保存至"
  [need_root]="此操作需要 root 权限，请使用 sudo 运行"
  [cleaning]="正在清理残留进程..."
)

declare -A en=(
  [welcome]="===== Suoha One-Click (2026 v3.2) ====="
  [choose]="1) Temporary Tunnel\n2) Fixed Tunnel (Domain + Auto-start)\n3) Cleanup All\n0) Exit"
  [lang_prompt]="Select language (1=Chinese / 2=English): "
  [fixed_need]="Requires Cloudflare domain. Follow the browser auth prompt later."
  [fixed_domain]="Enter your full domain (e.g., node.example.com): "
  [fixed_success]="Fixed tunnel running and auto-start configured"
  [links_saved]="Nodes saved to"
  [need_root]="This action requires root privileges. Please use sudo."
  [cleaning]="Cleaning up processes..."
)

# ---------------- 基础功能 ----------------
if [[ ! -f "$LANG_FILE" ]]; then
  echo -e "${zh[lang_prompt]}${en[lang_prompt]}"
  read -p "> " l
  [[ "$l" == "1" ]] && echo zh >"$LANG_FILE" || echo en >"$LANG_FILE"
fi
LANGUAGE=$(cat "$LANG_FILE")
t(){ eval "echo -e \"\${${LANGUAGE}[$1]}\""; }

green(){ echo -e "\033[32m$1\033[0m"; }
yellow(){ echo -e "\033[33m$1\033[0m"; }
red(){ echo -e "\033[31m$1\033[0m"; }

get_isp(){
  curl -4 -s https://speed.cloudflare.com/meta | jq -r '"\(.city)-\(.asn)"' 2>/dev/null || echo "Cloudflare_Edge"
}

install_deps(){
  command -v curl unzip jq >/dev/null && return
  yellow "Installing dependencies..."
  if command -v apt >/dev/null; then
    sudo apt update && sudo apt install -y curl unzip jq
  elif command -v dnf >/dev/null; then
    sudo dnf install -y curl unzip jq
  else
    apk add curl unzip jq bash || { red "Unsupported OS"; exit 1; }
  fi
}

download_bins(){
  [[ -x "$XRAY_BIN" && -x "$ARGO_BIN" ]] && return
  ARCH=$(uname -m)
  case "$ARCH" in
    x86_64|amd64) xrayf="Xray-linux-64.zip"; cfarch="amd64" ;;
    aarch64|arm64) xrayf="Xray-linux-arm64-v8a.zip"; cfarch="arm64" ;;
    *) red "Unsupported arch: $ARCH"; exit 1 ;;
  esac

  curl -L "https://github.com/XTLS/Xray-core/releases/latest/download/$xrayf" -o x.zip
  unzip -o x.zip xray -d "$BASE_DIR"
  curl -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-$cfarch" -o "$ARGO_BIN"
  chmod +x "$XRAY_BIN" "$ARGO_BIN"
  rm -f x.zip
}

# ---------------- 配置生成 ----------------
generate_configs(){
  UUID=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || echo "550e8400-e29b-41d4-a716-446655440000")
  PORT=$((RANDOM % 10000 + 20000))
  WS_PATH="/suoha-$(date +%s)"

  cat >"$CONFIG_FILE"<<EOF
{
 "inbounds": [{
   "port": $PORT, "listen": "127.0.0.1", "protocol": "vmess",
   "settings": {"clients": [{"id": "$UUID"}]},
   "streamSettings": {"network": "ws", "wsSettings": {"path": "$WS_PATH"}}
 }],
 "outbounds": [{"protocol": "freedom"}]
}
EOF
  echo "$UUID $WS_PATH $PORT"
}

show_links(){
  local domain="$1" uuid="$2" path="$3" isp="$4" mode="$5"
  # 使用官方域作为默认 Add，利用 CF 隧道 Host 进行路由
  local json=$(cat <<EOF
{"v":"2","ps":"Suoha_${mode}_$isp","add":"cloudflare.518920.xyz","port":"443","id":"$uuid","aid":"0","net":"ws","type":"none","host":"$domain","path":"$path","tls":"tls","sni":"$domain"}
EOF
)
  local vmess="vmess://$(echo -n "$json" | base64 -w0)"
  local file="$BASE_DIR/nodes_${mode}.txt"
  echo "$vmess" > "$file"
  green "\n$(t links_saved) $file"
  yellow "$vmess\n"
}

# ---------------- 隧道逻辑 ----------------
quick_tunnel(){
  download_bins
  read UUID WS_PATH PORT <<<"$(generate_configs)"
  ISP=$(get_isp)

  pkill -f "cloudflared tunnel" || true
  nohup "$XRAY_BIN" run -c "$CONFIG_FILE" >"$XRAY_LOG" 2>&1 &
  nohup "$ARGO_BIN" tunnel --url "http://127.0.0.1:$PORT" >"$ARGO_LOG" 2>&1 &

  yellow "Waiting for Argo Tunnel (max 30s)..."
  for _ in {1..30}; do
    DOMAIN=$(grep -oE 'https://[-a-z0-9]+\.trycloudflare\.com' "$ARGO_LOG" | head -1 | sed 's/https:\/\///' || true)
    [[ -n "$DOMAIN" ]] && break
    sleep 1
  done

  [[ -z "$DOMAIN" ]] && { red "Tunnel failed. Check $ARGO_LOG"; exit 1; }
  show_links "$DOMAIN" "$UUID" "$WS_PATH" "$ISP" "Quick"
}

fixed_tunnel(){
  [[ $EUID -ne 0 ]] && { red "$(t need_root)"; exit 1; }
  yellow "$(t fixed_need)"
  download_bins
  read UUID WS_PATH PORT <<<"$(generate_configs)"
  ISP=$(get_isp)

  "$ARGO_BIN" tunnel login
  read -p "$(t fixed_domain)" FULL_DOMAIN
  T_NAME="suoha-$(date +%s)"

  "$ARGO_BIN" tunnel create "$T_NAME" || true
  "$ARGO_BIN" tunnel route dns "$T_NAME" "$FULL_DOMAIN"

  CREDS_FILE=$(ls ~/.cloudflared/*.json | head -1)

  cat >"$TUNNEL_CONFIG"<<EOF
tunnel: $T_NAME
credentials-file: $CREDS_FILE
ingress:
  - hostname: $FULL_DOMAIN
    service: http://localhost:$PORT
  - service: http_status:404
EOF

  # 设置 Systemd
  cat >/etc/systemd/system/suoha-xray.service<<EOF
[Unit]
Description=Suoha Xray Service
After=network.target

[Service]
ExecStart=$XRAY_BIN run -c $CONFIG_FILE
Restart=always
User=$USER

[Install]
WantedBy=multi-user.target
EOF

  cat >/etc/systemd/system/suoha-argo.service<<EOF
[Unit]
Description=Suoha Cloudflared Tunnel
After=network.target

[Service]
ExecStart=$ARGO_BIN tunnel --config $TUNNEL_CONFIG run $T_NAME
Restart=always
User=$USER

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable --now suoha-xray suoha-argo
  
  show_links "$FULL_DOMAIN" "$UUID" "$WS_PATH" "$ISP" "Fixed"
  green "$(t fixed_success)"
}

# ---------------- 菜单 ----------------
clear
install_deps
green "$(t welcome)"
echo -e "$(t choose)"
read -p "> " c
case "$c" in
  1) quick_tunnel ;;
  2) fixed_tunnel ;;
  3) 
    yellow "$(t cleaning)"
    pkill -f xray || true
    pkill -f cloudflared || true
    [[ $EUID -eq 0 ]] && { systemctl stop suoha-xray suoha-argo 2>/dev/null || true; }
    ;;
  *) exit 0 ;;
esac
